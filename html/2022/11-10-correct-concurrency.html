<!DOCTYPE html>

<html lang="ru">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Параллельность</title>

  <link rel="stylesheet" type="text/css" href="../main.css"/>
</head>

<body><h2>Внедрение параллельности в однопоточный язык, не нарушающее совместимости</h2>

<div>
<div id="parimg0" class="separator" style="clear: both;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiDyT49oxFl_Eghsy76y0fRJekU9w616jX1lX4W8awj_9YQGFROSh5dUkRE9Kczx0JBh5AHPCLaT__ShESmSeDImCD4Qwuoa3KLdcKCVq2JNrAKjoZYWPOgBaTgOubigDScwNV0KbDQ-DMfi1nBZ8MFNocxzofE_LfCaasus_8ZIqFV8MBRkuSqYg1Yo5k/s1024/DALL%C2%B7E%202023-11-19%2022.35.23%20-%20An%20image%20of%20several%20rockets%20flying%20synchronously%20in%20the%20sky,%20leaving%20behind%20parallel,%20multicolored%20trails,%20with%20the%20planet%20Uranus%20prominently%20visible%20.png" style="display: block; padding: 0 1em; text-align: center; clear: right; float: right;"><img alt="" border="0" width="320" data-original-height="1024" data-original-width="1024" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiDyT49oxFl_Eghsy76y0fRJekU9w616jX1lX4W8awj_9YQGFROSh5dUkRE9Kczx0JBh5AHPCLaT__ShESmSeDImCD4Qwuoa3KLdcKCVq2JNrAKjoZYWPOgBaTgOubigDScwNV0KbDQ-DMfi1nBZ8MFNocxzofE_LfCaasus_8ZIqFV8MBRkuSqYg1Yo5k/s320/DALL%C2%B7E%202023-11-19%2022.35.23%20-%20An%20image%20of%20several%20rockets%20flying%20synchronously%20in%20the%20sky,%20leaving%20behind%20parallel,%20multicolored%20trails,%20with%20the%20planet%20Uranus%20prominently%20visible%20.png"/></a></div>  
<div id="parimg1" class="separator" style="clear: both;display:none;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8X1YyPrQPLZltMCnjySGkpXzaPABiI6nPc4wquVURGtchsJJOb5hp9dCowsT3HYEj0BNpuIFbigTtuwcS0fJj5gL8YJCKpWuIP8PmOGiosBkuV6k8vx77_yiZqRIk-wI8l-ZSzjVNL7s3bR4vkx-pR4NEaxwDyzd3G5q2YlJ_3O7DaldickXw23NLbIs/s1024/DALL%C2%B7E%202023-11-19%2022.29.03%20-%20An%20image%20of%20several%20rockets%20flying%20synchronously%20in%20the%20sky,%20leaving%20behind%20parallel,%20multicolored%20trails.%20The%20scene%20should%20capture%20the%20majesty%20and%20po.png" style="display: block; padding: 0 1em; text-align: center; clear: right; float: right;"><img alt="" border="0" width="320" data-original-height="1024" data-original-width="1024" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8X1YyPrQPLZltMCnjySGkpXzaPABiI6nPc4wquVURGtchsJJOb5hp9dCowsT3HYEj0BNpuIFbigTtuwcS0fJj5gL8YJCKpWuIP8PmOGiosBkuV6k8vx77_yiZqRIk-wI8l-ZSzjVNL7s3bR4vkx-pR4NEaxwDyzd3G5q2YlJ_3O7DaldickXw23NLbIs/s320/DALL%C2%B7E%202023-11-19%2022.29.03%20-%20An%20image%20of%20several%20rockets%20flying%20synchronously%20in%20the%20sky,%20leaving%20behind%20parallel,%20multicolored%20trails.%20The%20scene%20should%20capture%20the%20majesty%20and%20po.png"/></a></div>
</div>
<script>
  (function() {
    if (Math.random() < 0.2) {
      document.getElementById('parimg0').style.display = 'none';
      document.getElementById('parimg1').style.display = '';
    }
  })();
</script>

<p>Если типичный императивный язык программирования был в начальной задумке однопоточным, то наивное добавление в него многопоточности не может быть осуществлено без слома совместимости, так как нарушает фундаментальное свойство, гарантирующее неизменность доступных переменных при отсутствии их изменений со стороны самого потока. Приёмы работы с данными, которые были совершенно приемлемы в однопоточности, могут оказаться неадекватными в многопоточном. Такой слом в языке не является чем-то совсем недопустимым, если сама платформа зарождалась в такой среде и накопление кода всегда происходило с учётом этой особенности. Но даже в этом случае достижение правильности кода избыточно перекладывается на плечи программиста с сопутствующими результатами. Такой подход неприемлем для языков, создаваемых не только для того, чтобы не мешать, но и для того, чтобы помогать. Что можно предложить для них?</p>

<!--more-->

<h2>Основа</h2>

<p>Исходные свойства должны оставаться неизменным для данных и действий, объявленных в соответствии с исходной однопоточной спецификацией языка, а нововведения в ожидаемых эффектах должны предоставляться только через нововведения же в языке. В том числе это означает, что для потока по-прежнему верно, что обычные переменные не могут измениться как-то иначе, кроме как в самом этом потоке. И тонкая грань, пролегающая между ломающим внедрением параллельности и совместимым, заключается почти исключительно в трактовке понятия глобальности. В первом случае она считается абсолютной, а во втором — относительной. Последнее означает, что потоки преимущественно логически изолируются друг от друга и большей частью своего состояния распоряжаются единолично, что гарантируется языком, а не просто дисциплиной разработчика. Важно отметить, что изоляция хороша не только для параллельности.</p>

<ul>
  <li>Обычные глобальные переменные должны быть глобальными лишь в рамках потока. Для системы в целом они должны быть локально привязаны к своим потокам.</li>
  <li>Динамически выделямые данные тоже изначально логически обособлены и привязаны к потоку. Язык не должен позволять потокам просто так обмениваться обычными указателями.</li>
</ul>
<p>
Такой подход можно назвать многооднопоточностью. В ней запущенный параллельно код, даже если он никогда для этого не предназначался, не вступит в противоречие с другим потоком и будет выполняться ровно так же, как в однопоточной среде. В худшем случае это приведёт лишь к дополнительному расходу памяти из-за избыточного дублирования. Но не жертвуя корректностью систему можно постепенно дорабатывать, объединяя те данные, для которых это уместно. Работу с данными, общими по своей природе, в любом случае необходимо дорабатывать относительно однопоточного кода.</p>

<h2>Добавление</h2>
<p>Обмен данными между потоками возможен через:</p>
<ul>
  <li> Значения, к которым можно причислить и указатели на неизменяемые данные. Не скрытые для изменения извне, а именно закреплённые. Такие данные не обязаны одномоментно создаваться такими, а могут проходить этап начализации, в течении которого могут рассматриваться как изменяемые. </li>
  <li> Изменяемые данные с передачей владения.
    <ul>
      <li>Передача результата при завершении подзадачи. Незадействованные в возврате данные могут быть эффективно освобождены локальной для потока сборкой мусора без необходимости обхода глобальной кучи и с минимальной пометкой полезных данных. Часть задач может быть гармонично разбита на очевидные этапы, для которых конец одного инициирует начало следующего. Разбиение на подзадачи полезно даже в однопоточности, и может рассматриваться как дополнительное средство структурирования.</li>
      <li>Данные, уникальность владения которыми обеспечивается статически подтверждаемой концепцией владения. Надёжно, но может оказаться слишком ограниченным или слишком сложным для простого языка, как в воплощении транслятора, так и в использовании программистом.</li>
      <li>Данные, отсутствие лишних ссылок на которые подтверждается сборщиком мусора, удостоверяющего, что для исходного потока они стали лишними. Просто для программиста при оптимистическом сценарии, но может быть ресурсоёмким и возможны сложно отслеживаемые ошибки в коде, блокирующие передачу. Если для управления памятью используется автоматический подсчёт ссылок, то проверка на уникальность может быть быстрой, но проблема блокировки передачи из-за забытых ссылок остаётся.
      </li>
      <li id='storage-owner'>Хранилище, неразделяемо владеющее данными и предоставляющее доступ к ним только через своё посредничество. При передаче владения хранилище опустошается, гарантированно лишая доступа к данным со стороны первоначального владельца. Это эффективно и просто воплотимо, но требует ввести дополнительный тип ссылок. Может приводить к ошибкам времени исполнения при неосторожных попытках обращения к данным из закрытого хранилища.</li>
      <li>Нечто среднее между двумя предыдущими. Сборщик мусора не проверяет, а осуществляет отсутствие лишних ссылок на передаваемые данные, очищая ссылающиеся на них указатели. Может показаться удобным, но частично ломает совместимость, потому что создаёт возможность исчезновения данных, минуя обычные механизмы защиты данных.</li>
    </ul>
  </li>
  <li>Изменяемые данные с защитой от одновременного изменения. Либо явно обозначенные как разделяемые, либо скрытые за другими высокоуровневыми механизмами, например, каналами ввода-вывода.
    <ul>
      <li>Доступ к явному управлению блокировками стоит признать нежелательным, но может быть предоставлен как некий ограниченный низкоуровневый механизм.</li>
      <li>Монопольный доступ на изменения может осуществляться через неявные блокировки.</li>
      <li>Параллельное чтение допускается, но новые участники могут включаться в него только при отсутствии запроса на запись.</li>
      <li>Для гарантии остутствия взаимных блокировок<a href='#[0]'>[0]</a>
        <ul><li>Необходимо ограничение доступа таким способом, чтобы процесс одновременно мог блокировать либо только один ресурс, либо несколько, но в строгом порядке. Может быть либо сковывающим для программиста, либо сложно воплотимым.</li>
          <li>Либо динамическое отслеживание за количеством и порядком блокировок. Повышает гибкость и проще воплотимо, но способно приводить к ошибкам исполнения.</li>
        </ul>
      </li>
      <li>Потоки, обменивающиеся данными только через каналы ввода-вывода, являются частным случаем систем, в которых можно блокировать не более одного ресурса одновременно. Байтовые каналы и обёртки над ними — это решение для языков с минимальной поддержкой многопоточности. Более развитая поддержка подразумевает возможность обмена полноценными структурами, включая через указатели при соблюдении ранее описанных условий.</li>
    </ul>
  </li>
</ul>

<details><summary>Примечания</summary>
  <a id='[0]'>[0]</a> Речь идёт о гарантиях отсутствия блокировок на уровне терминов языка. Понятие блокировки может быть воспроизведено в других терминах. Смотрите, например, 
  <a href="https://comdivbyzero.blogspot.com/2023/10/single-thread-deadlock.html">код получения взаимных блокировок в однопоточном языке, запускаемом в многозадачной среде</a>.
</details>

<details><summary>Смотрите также</summary>
  <a href='https://youtu.be/RvDhXbLp_Us'>Рифат Сабирзянов - Concurrency with shared variable considered harmful на YouTube</a>
</details>

</body>
</html>
